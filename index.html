<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BlinkArcher AR: Arcade Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;700;900&display=swap');

        :root {
            --neon-primary: #00f2ff;
            --neon-secondary: #7000ff;
            --neon-accent: #ff00c8;
            --neon-success: #39ff14;
        }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #000; overflow: hidden; position: fixed;
            font-family: 'Inter', sans-serif; touch-action: none;
        }

        .font-arcade { font-family: 'Orbitron', sans-serif; }

        #container {
            position: absolute; 
            inset: 0;
            width: 100vw;
            height: 100dvh; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            background: #000;
            overflow: hidden;
        }

        video, canvas {
            position: absolute; 
            top: 0; 
            left: 0;
            width: 100% !important; 
            height: 100% !important;
            transform: scaleX(-1);
            object-fit: cover; 
            z-index: 1;
        }

        #overlay { z-index: 2; pointer-events: none; }

        .glass {
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ui-layer {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            color: white;
            text-shadow: 0 2px 10px rgba(0,0,0,0.9);
        }

        /* Updated HUD Layout for Notch/Safe Area Visibility */
        .hud-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            padding-top: max(1rem, env(safe-area-inset-top));
            padding-left: max(1rem, env(safe-area-inset-left));
            padding-right: max(1rem, env(safe-area-inset-right));
        }

        .timer-badge {
            background: rgba(0,0,0,0.7);
            padding: 0.6rem 1.2rem;
            border-radius: 999px;
            border: 2px solid #ef4444;
            font-weight: 900;
            font-size: 1.2rem;
            backdrop-filter: blur(10px);
        }

        .stats-badge {
            background: rgba(0,0,0,0.7);
            padding: 0.8rem 1rem;
            border-radius: 1.25rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        @keyframes pulse-red {
            0%, 100% { border-color: #ef4444; box-shadow: 0 0 5px #ef4444; }
            50% { border-color: #ff0000; box-shadow: 0 0 20px #ff0000; }
        }
        .animate-pulse-critical { animation: pulse-red 0.5s infinite; }

        @keyframes ripple {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }
        .ripple {
            position: absolute; border: 2px solid white; border-radius: 50%;
            pointer-events: none; animation: ripple 0.6s ease-out forwards;
            z-index: 15;
        }

        .btn-arcade {
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto;
        }
        .btn-arcade:active { transform: scale(0.95); }

        .selector-item {
            transition: all 0.2s ease;
            cursor: pointer;
            pointer-events: auto;
        }
        .selector-item.active {
            background: var(--neon-primary);
            color: black;
            box-shadow: 0 0 15px var(--neon-primary);
        }

        .screen-fade { transition: opacity 0.4s ease, transform 0.4s ease; }
        .hidden-screen { opacity: 0; transform: scale(0.95); pointer-events: none !important; }

        .modal {
            pointer-events: auto;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(25px);
            padding: 2.5rem 2rem;
            border-radius: 2.5rem;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.8);
            max-width: 85%;
            margin: auto;
        }

        .combo-meter {
            position: absolute; top: 50%; right: 5%;
            transform: translateY(-50%);
            display: flex; flex-direction: column; align-items: center;
        }
    </style>
</head>
<body>

<div id="container">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
    
    <div class="ui-layer">
        <!-- START SCREEN -->
        <div id="start-screen" class="screen-fade flex flex-col items-center justify-center h-full pointer-events-auto">
            <div class="modal glass rounded-[2.5rem] p-8 w-full max-w-sm flex flex-col items-center border-t border-white/10">
                <h1 class="font-arcade text-3xl font-black text-white italic mb-1 tracking-tighter uppercase">BLINKARCHER</h1>
                <p class="text-[9px] uppercase tracking-[0.4em] text-cyan-400 mb-8 font-bold">Arcade Protocol Ready</p>

                <div class="w-full space-y-6 mb-8 text-white">
                    <div>
                        <label class="text-[9px] uppercase font-bold text-white/40 mb-3 block text-center tracking-widest">Duration</label>
                        <div class="flex justify-between gap-2" id="time-selector">
                            <div class="selector-item glass flex-1 py-2 rounded-xl text-center font-arcade text-xs active" data-val="10">10s</div>
                            <div class="selector-item glass flex-1 py-2 rounded-xl text-center font-arcade text-xs" data-val="20">20s</div>
                            <div class="selector-item glass flex-1 py-2 rounded-xl text-center font-arcade text-xs" data-val="30">30s</div>
                        </div>
                    </div>
                    <div>
                        <label class="text-[9px] uppercase font-bold text-white/40 mb-3 block text-center tracking-widest">Arrows</label>
                        <div class="flex justify-between gap-2" id="arrow-selector">
                            <div class="selector-item glass flex-1 py-2 rounded-xl text-center font-arcade text-xs" data-val="3">03</div>
                            <div class="selector-item glass flex-1 py-2 rounded-xl text-center font-arcade text-xs active" data-val="5">05</div>
                            <div class="selector-item glass flex-1 py-2 rounded-xl text-center font-arcade text-xs" data-val="10">10</div>
                        </div>
                    </div>
                </div>

                <button id="start-btn" class="btn-arcade w-full py-5 rounded-2xl bg-cyan-400 text-black font-black text-xl italic tracking-tighter shadow-[0_0_30px_rgba(34,211,238,0.3)] disabled:opacity-20" disabled>
                    LOADING AI...
                </button>
            </div>
        </div>

        <!-- HUD -->
        <div id="hud" class="hidden-screen flex flex-col justify-between h-full w-full screen-fade">
            <div class="hud-top">
                <div class="stats-badge glass min-w-[100px]">
                    <div class="text-[9px] uppercase font-bold text-cyan-400 tracking-widest mb-1">SCORE</div>
                    <div id="score-val" class="font-arcade text-3xl font-black tabular-nums">0000</div>
                    <div id="arrow-container" class="flex gap-1 mt-3 h-4"></div>
                </div>
                
                <div id="timer-box" class="timer-badge border-2 border-cyan-400 flex flex-col items-center">
                    <span id="timer-val" class="font-arcade text-2xl font-black tabular-nums">10</span>
                </div>
            </div>

            <!-- Feedback Bar -->
            <div class="absolute bottom-10 left-1/2 -translate-x-1/2 w-32 h-1 glass rounded-full overflow-hidden">
                <div id="blink-fill" class="h-full bg-cyan-400 transition-all duration-75" style="width: 0%"></div>
            </div>

            <div id="combo-hud" class="combo-meter opacity-0 transition-opacity duration-300">
                <div class="text-xs font-black text-pink-500 tracking-tighter uppercase italic opacity-70">COMBO</div>
                <div id="combo-val" class="font-arcade text-5xl font-black italic text-pink-500">x1</div>
            </div>
        </div>

        <!-- RESULTS SCREEN -->
        <div id="end-screen" class="hidden-screen screen-fade flex flex-col items-center justify-center h-full pointer-events-auto">
            <div class="modal glass rounded-[2.5rem] p-10 w-full max-w-sm flex flex-col items-center">
                <div id="rank-badge" class="px-4 py-1 rounded bg-pink-500 text-black font-black text-[9px] tracking-widest uppercase mb-4 text-white">RECRUIT</div>
                <div id="final-score" class="font-arcade text-7xl font-black text-white italic mb-8">000</div>
                
                <div class="w-full grid grid-cols-2 gap-3 mb-8">
                    <div class="glass rounded-2xl p-4 text-center">
                        <div class="text-[8px] opacity-40 font-bold uppercase tracking-widest text-white">BEST</div>
                        <div id="best-score" class="font-arcade text-lg text-cyan-400">0</div>
                    </div>
                    <div class="glass rounded-2xl p-4 text-center">
                        <div class="text-[8px] opacity-40 font-bold uppercase tracking-widest text-white">AVG.</div>
                        <div id="avg-score" class="font-arcade text-lg text-pink-500">0</div>
                    </div>
                </div>

                <div class="w-full space-y-3">
                    <button id="restart-btn" class="btn-arcade w-full py-4 rounded-xl bg-white text-black font-black text-lg italic tracking-tighter">REPLAY</button>
                    <button id="menu-btn" class="btn-arcade w-full py-3 rounded-xl glass text-white font-bold text-xs uppercase tracking-widest">SETTINGS</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { FaceLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

    const CONFIG = {
        sensitivity: 0.45,
        hitRadius: 0.1, 
        colors: {
            primary: '#00f2ff',
            secondary: '#ff00c8',
            success: '#39ff14',
            fail: '#ff0000'
        }
    };

    let state = {
        gameState: 'START',
        score: 0,
        arrows: 5,
        time: 10,
        combo: 1,
        totalGames: parseInt(localStorage.getItem('ba_totalGames')) || 0,
        allTimeScore: parseInt(localStorage.getItem('ba_allTimeScore')) || 0,
        bestScore: parseInt(localStorage.getItem('ba_bestScore')) || 0,
        lastVideoTime: -1,
        hasFired: false
    };

    const video = document.getElementById('video');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    
    let faceLandmarker;
    let timerInterval;
    let audioCtx;
    let particles = [];
    let target = { x: 0.5, y: 0.5, vx: 0.005, vy: 0.003, active: false };
    let crosshair = { x: 0.5, y: 0.5, active: false };

    function mapVideoToScreen(coordX, coordY) {
        if (!video.videoWidth) return { x: coordX, y: coordY };
        const videoAspect = video.videoWidth / video.videoHeight;
        const screenAspect = window.innerWidth / window.innerHeight;
        let mappedX = coordX;
        let mappedY = coordY;
        if (videoAspect > screenAspect) {
            const visibleWidth = screenAspect / videoAspect;
            mappedX = (coordX - (1 - visibleWidth) / 2) / visibleWidth;
        } else {
            const visibleHeight = videoAspect / screenAspect;
            mappedY = (coordY - (1 - visibleHeight) / 2) / visibleHeight;
        }
        return { x: mappedX, y: mappedY };
    }

    function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function toggleFullscreen() {
        const docEl = document.documentElement;
        const requestFS = docEl.requestFullscreen || docEl.webkitRequestFullScreen || docEl.mozRequestFullScreen || docEl.msRequestFullscreen;
        if (requestFS) requestFS.call(docEl).catch(() => {});
    }

    function playSound(type) {
        if (!audioCtx) return;
        const now = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.connect(g); g.connect(audioCtx.destination);
        if (type === 'shoot') {
            osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(50, now + 0.1);
            g.gain.setValueAtTime(0.1, now); g.gain.linearRampToValueAtTime(0, now + 0.1);
            osc.start(); osc.stop(now + 0.1);
        } else if (type === 'hit') {
            osc.frequency.setValueAtTime(800 + (state.combo * 50), now); osc.frequency.exponentialRampToValueAtTime(1600, now + 0.05);
            g.gain.setValueAtTime(0.15, now); g.gain.linearRampToValueAtTime(0, now + 0.2);
            osc.start(); osc.stop(now + 0.2);
            if (navigator.vibrate) navigator.vibrate(50);
        } else if (type === 'miss') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(120, now);
            g.gain.setValueAtTime(0.05, now); g.gain.linearRampToValueAtTime(0, now + 0.3);
            osc.start(); osc.stop(now + 0.3);
            if (navigator.vibrate) navigator.vibrate([30, 20]);
        }
    }

    async function initAR() {
        try {
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
            faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`,
                    delegate: "GPU"
                },
                outputFaceBlendshapes: true,
                runningMode: "VIDEO",
                numFaces: 1
            });
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
                audio: false
            });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                const resize = () => {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                };
                window.addEventListener('resize', resize);
                resize();
                document.getElementById('start-btn').innerText = "ENTER ARENA";
                document.getElementById('start-btn').disabled = false;
                requestAnimationFrame(loop);
            };
        } catch (e) {
            document.getElementById('start-btn').innerText = "CAMERA BLOCKED";
        }
    }

    function spawnTarget() {
        target.x = 0.2 + Math.random() * 0.6;
        target.y = 0.2 + Math.random() * 0.6;
        const diff = 1 + (state.score / 150);
        target.vx = (Math.random() - 0.5) * 0.015 * diff;
        target.vy = (Math.random() - 0.5) * 0.015 * diff;
        target.active = true;
    }

    function fire() {
        if (state.gameState !== 'PLAYING' || state.arrows <= 0) return;
        state.arrows--;
        playSound('shoot');
        const dx = Math.abs(crosshair.x - target.x);
        const dy = Math.abs(crosshair.y - target.y);
        if (dx < CONFIG.hitRadius && dy < CONFIG.hitRadius) {
            state.score += 10 * state.combo;
            state.combo++;
            playSound('hit');
            triggerRipple(target.x, target.y);
            createParticles(target.x, target.y, CONFIG.colors.success);
            spawnTarget();
            if (state.combo > 1) {
                const c = document.getElementById('combo-hud');
                c.classList.replace('opacity-0', 'opacity-100');
                document.getElementById('combo-val').innerText = `x${state.combo}`;
            }
        } else {
            state.combo = 1;
            playSound('miss');
            createParticles(crosshair.x, crosshair.y, CONFIG.colors.fail);
            document.getElementById('combo-hud').classList.replace('opacity-100', 'opacity-0');
        }
        updateHUD();
        if (state.arrows === 0) setTimeout(endGame, 1000);
    }

    function triggerRipple(x, y) {
        const div = document.createElement('div');
        div.className = 'ripple';
        div.style.left = `${(1 - x) * 100}%`;
        div.style.top = `${y * 100}%`;
        div.style.width = '120px'; div.style.height = '120px';
        div.style.marginLeft = '-60px'; div.style.marginTop = '-60px';
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 600);
    }

    function createParticles(x, y, color) {
        for (let i = 0; i < 15; i++) {
            particles.push({
                x, y, vx: (Math.random() - 0.5) * 0.05, vy: (Math.random() - 0.5) * 0.05,
                life: 1.0, color
            });
        }
    }

    function updateHUD() {
        document.getElementById('score-val').innerText = state.score.toString().padStart(4, '0');
        document.getElementById('timer-val').innerText = Math.ceil(state.time);
        const container = document.getElementById('arrow-container');
        container.innerHTML = '';
        const count = parseInt(document.querySelector('#arrow-selector .active').dataset.val);
        for(let i=0; i<count; i++) {
            container.innerHTML += `<div class="w-2.5 h-full rounded-sm ${i < state.arrows ? 'bg-cyan-400 shadow-[0_0_10px_#00f2ff]' : 'bg-white/10'}"></div>`;
        }
        if (state.time <= 3) document.getElementById('timer-box').classList.add('animate-pulse-critical');
        else document.getElementById('timer-box').classList.remove('animate-pulse-critical');
    }

    function loop() {
        if (video.currentTime !== state.lastVideoTime && faceLandmarker) {
            state.lastVideoTime = video.currentTime;
            const res = faceLandmarker.detectForVideo(video, performance.now());
            if (res.faceLandmarks && res.faceLandmarks.length > 0) {
                crosshair.active = true;
                const noseRaw = res.faceLandmarks[0][168];
                const mapped = mapVideoToScreen(noseRaw.x, noseRaw.y);
                crosshair.x = mapped.x;
                crosshair.y = mapped.y;
                if (res.faceBlendshapes && res.faceBlendshapes.length > 0) {
                    const blinks = res.faceBlendshapes[0].categories;
                    const bL = blinks.find(c => c.categoryName === 'eyeBlinkLeft')?.score || 0;
                    const bR = blinks.find(c => c.categoryName === 'eyeBlinkRight')?.score || 0;
                    const blink = (bL + bR) / 2;
                    document.getElementById('blink-fill').style.width = `${blink * 100}%`;
                    if (blink > CONFIG.sensitivity) {
                        if (!state.hasFired) { fire(); state.hasFired = true; }
                    } else { state.hasFired = false; }
                }
            } else { crosshair.active = false; }
        }
        render();
        requestAnimationFrame(loop);
    }

    function render() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const w = canvas.width;
        const h = canvas.height;
        if (crosshair.active) {
            const cx = crosshair.x * w;
            const cy = crosshair.y * h;
            ctx.strokeStyle = state.hasFired ? CONFIG.colors.fail : CONFIG.colors.primary;
            ctx.lineWidth = 4;
            ctx.beginPath(); ctx.arc(cx, cy, 32, 0, Math.PI * 2); ctx.stroke();
            ctx.beginPath(); 
            ctx.moveTo(cx - 45, cy); ctx.lineTo(cx - 15, cy);
            ctx.moveTo(cx + 45, cy); ctx.lineTo(cx + 15, cy);
            ctx.moveTo(cx, cy - 45); ctx.lineTo(cx, cy - 15);
            ctx.moveTo(cx, cy + 45); ctx.lineTo(cx, cy + 15);
            ctx.stroke();
            ctx.fillStyle = ctx.strokeStyle;
            ctx.beginPath(); ctx.arc(cx, cy, 5, 0, Math.PI * 2); ctx.fill();
        }
        if (state.gameState === 'PLAYING' && target.active) {
            target.x += target.vx; target.y += target.vy;
            if (target.x < 0.1) { target.x = 0.1; target.vx *= -1; }
            if (target.x > 0.9) { target.x = 0.9; target.vx *= -1; }
            if (target.y < 0.2) { target.y = 0.2; target.vy *= -1; }
            if (target.y > 0.8) { target.y = 0.8; target.vy *= -1; }
            const tx = target.x * w;
            const ty = target.y * h;
            ctx.fillStyle = "white";
            ctx.beginPath(); ctx.arc(tx, ty, 35, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = CONFIG.colors.secondary;
            ctx.beginPath(); ctx.arc(tx, ty, 25, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = "white";
            ctx.beginPath(); ctx.arc(tx, ty, 10, 0, Math.PI * 2); ctx.fill();
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx; p.y += p.vy; p.life -= 0.03;
                if (p.life <= 0) { particles.splice(i, 1); continue; }
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.life;
                ctx.fillRect(p.x * w, p.y * h, 6, 6);
            }
            ctx.globalAlpha = 1.0;
        }
    }

    function startGame() {
        initAudio();
        toggleFullscreen();
        state.gameState = 'PLAYING';
        state.score = 0;
        state.combo = 1;
        state.time = parseInt(document.querySelector('#time-selector .active').dataset.val);
        state.arrows = parseInt(document.querySelector('#arrow-selector .active').dataset.val);
        spawnTarget();
        updateHUD();
        document.getElementById('start-screen').classList.add('hidden-screen');
        document.getElementById('end-screen').classList.add('hidden-screen');
        document.getElementById('hud').classList.remove('hidden-screen');
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            state.time--;
            updateHUD();
            if (state.time <= 0) endGame();
        }, 1000);
    }

    function endGame() {
        if (state.gameState === 'END') return;
        state.gameState = 'END';
        clearInterval(timerInterval);
        state.totalGames++;
        state.allTimeScore += state.score;
        if (state.score > state.bestScore) state.bestScore = state.score;
        localStorage.setItem('ba_totalGames', state.totalGames);
        localStorage.setItem('ba_allTimeScore', state.allTimeScore);
        localStorage.setItem('ba_bestScore', state.bestScore);
        document.getElementById('hud').classList.add('hidden-screen');
        document.getElementById('end-screen').classList.remove('hidden-screen');
        document.getElementById('final-score').innerText = state.score.toString().padStart(3, '0');
        document.getElementById('best-score').innerText = state.bestScore;
        document.getElementById('avg-score').innerText = Math.round(state.allTimeScore / state.totalGames);
        const rank = state.score >= 100 ? 'LEGEND' : state.score >= 60 ? 'ELITE' : 'SOLDIER';
        document.getElementById('rank-badge').innerText = rank;
    }

    document.querySelectorAll('.selector-item').forEach(el => {
        el.onclick = () => {
            el.parentElement.querySelectorAll('.selector-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        };
    });

    document.getElementById('start-btn').onclick = startGame;
    document.getElementById('restart-btn').onclick = startGame;
    document.getElementById('menu-btn').onclick = () => {
        document.getElementById('end-screen').classList.add('hidden-screen');
        document.getElementById('start-screen').classList.remove('hidden-screen');
    };

    window.onload = initAR;
</script>
</body>
</html>
